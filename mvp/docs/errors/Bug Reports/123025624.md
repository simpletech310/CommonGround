# CommonGround Frontend MVP - Bug Report

**Date:** December 30, 2025  
**Reporter:** TJ  
**Environment:** Frontend MVP  
**Priority:** HIGH - Blocking core functionality

---

## ğŸ› Active Bugs

### Bug #1: Missing Navigation Elements in Dashboard
**Severity:** MEDIUM
**Status:** ğŸŸ¢ RESOLVED
**Component:** Dashboard / Navigation
**Resolved:** December 30, 2025

**Description:**
Navigation elements were missing from the dashboard.

**Expected Behavior:**
- Navigation menu should be present in dashboard
- Getting Started section should have clear navigation options

**Actual Behavior:**
- Navigation not visible/accessible in Getting Started window

**Resolution:**
- âœ… Created new `Navigation` component (`components/navigation.tsx`)
- âœ… Added navigation to dashboard with all pages (Dashboard, Cases, Messages, Agreements, Schedule)
- âœ… Implemented responsive design (desktop and mobile versions)
- âœ… Added active page highlighting

**Files Modified:**
- Created: `frontend/components/navigation.tsx`
- Modified: `frontend/app/dashboard/page.tsx` (integrated Navigation component)

---

### Bug #2: Missing Call-to-Action Buttons
**Severity:** MEDIUM
**Status:** ğŸŸ¢ RESOLVED
**Component:** Dashboard UI
**Resolved:** December 30, 2025

**Description:**
Missing buttons under key dashboard sections for user actions.

**Expected Behavior:**
- Button under "Build Agreement" section
- Button under "Start Communicating" section

**Actual Behavior:**
- No buttons present in these sections

**Resolution:**
- âœ… Added "Build agreement" button to Step 2 (routes to /agreements)
- âœ… Added "Start communicating" button to Step 3 (routes to /messages)
- âœ… Matched styling with existing "Create case" button
- âœ… All buttons functional with proper navigation

**Files Modified:**
- `frontend/app/dashboard/page.tsx` (added buttons to Getting Started steps)

---

### Bug #3: Scheduling Missing from Navigation Menu
**Severity:** MEDIUM
**Status:** ğŸŸ¢ RESOLVED
**Component:** Navigation
**Resolved:** December 30, 2025

**Description:**
Scheduling feature was not present in the navigation menu.

**Expected Behavior:**
- Scheduling should appear in main navigation
- Should be accessible from all pages

**Actual Behavior:**
- Scheduling option not in navigation menu

**Resolution:**
- âœ… Created Navigation component with all pages including Schedule
- âœ… Schedule appears in main navigation alongside Dashboard, Cases, Messages, and Agreements
- âœ… Proper routing configured to `/schedule`
- âœ… Active page highlighting works for schedule page

**Files Modified:**
- `frontend/components/navigation.tsx` (includes Schedule in nav items)

---

### Bug #4: Build Agreement Fails to Load Case
**Severity:** CRITICAL ğŸš¨  
**Status:** ğŸ”´ Open  
**Component:** Agreement Builder

**Description:**
When clicking "Build Agreement" from a case, the application fails with an API error.

**Error Message:**
```
Failed to load case. Try again.

lib/api.ts (64:13) @ fetchAPI
62 | }
63 |
> 64 | throw new APIError(
   | ^
65 | errorData?.detail || `HTTP ${response.status}: ${response.statusText}`,
66 | response.status,
67 | errorData
```

**Expected Behavior:**
- Clicking "Build Agreement" should load the case data
- Should navigate to agreement builder with case context

**Actual Behavior:**
- API error thrown
- Cannot proceed to agreement builder
- User blocked from creating agreements

**Action Items:**
- [ ] Debug API call in `lib/api.ts`
- [ ] Verify case ID is being passed correctly
- [ ] Check backend endpoint `/api/v1/cases/{case_id}`
- [ ] Add error handling and user-friendly messages
- [ ] Test with valid case IDs

**Files to Check:**
- `lib/api.ts` (line 64)
- Agreement builder component
- Case context provider
- Backend: `app/api/v1/endpoints/cases.py`

**Debug Steps:**
1. Log case ID being passed
2. Verify case exists in database
3. Check API endpoint response
4. Verify authentication token
5. Test with different cases

---

### Bug #5: Message Send Fails with Object Error
**Severity:** CRITICAL ğŸš¨
**Status:** ğŸŸ¢ RESOLVED
**Component:** Messaging
**Resolved:** December 30, 2025

**Description:**
When sending a test message, validation passes but send fails with cryptic error.

**Error Message:**
```
Everything looks good! (validation passes)

[On send]
object object object object object
[object Object],[object Object],[object Object]
```

**Root Cause:**
Frontend was sending message data in wrong format. The backend expects:
```typescript
{
  case_id: string,
  recipient_id: string,
  content: string,
  thread_id?: string,
  message_type?: string
}
```

But frontend was wrapping it in `message_data` object:
```typescript
{
  message_data: { /* fields here */ },
  intervention_action?: { /* optional */ }
}
```

**Resolution:**
- âœ… Updated `SendMessageRequest` interface to match backend `MessageCreate` schema
- âœ… Removed `message_data` wrapper
- âœ… Made `recipient_id` required (as backend expects)
- âœ… Added `thread_id` optional field
- âœ… Backend now receives correctly formatted message data

**Files Modified:**
- `frontend/lib/api.ts` (updated SendMessageRequest interface and Message interface)

---

### Bug #6: ARIA Message Prompting Needs Improvement
**Severity:** MEDIUM  
**Status:** ğŸ”´ Open  
**Component:** ARIA / Messaging

**Description:**
ARIA system prompt needs improvement for better understanding of message context and providing appropriate interventions.

**Current Behavior:**
- ARIA not understanding message context well
- Suggestions may not be contextually appropriate

**Action Items:**
- [ ] Review current system prompt for ARIA
- [ ] Analyze failed intervention examples
- [ ] Improve context awareness in prompt
- [ ] Add agreement context to ARIA prompts
- [ ] Test with various message types
- [ ] Document prompt improvements

**Files to Check:**
- ARIA service configuration
- System prompt definition
- Message context builder
- Backend: `app/services/aria.py`

**Improvement Areas:**
1. Add case/agreement context to prompt
2. Include conversation history
3. Better toxicity detection examples
4. Clearer rewrite guidelines
5. Child welfare focus

---

### Bug #7: New Agreement Creation Returns 404
**Severity:** CRITICAL ğŸš¨
**Status:** ğŸŸ¢ RESOLVED
**Component:** Agreement Builder
**Resolved:** December 30, 2025

**Description:**
When creating a brand new agreement (any type), the system returns a 404 Not Found error.

**Root Cause:**
Frontend was calling the wrong endpoint. The agreement creation endpoint is case-specific:
- âŒ Frontend called: `POST /api/v1/agreements/` (doesn't exist)
- âœ… Actual endpoint: `POST /api/v1/cases/{case_id}/agreement`

Per backend comment in `agreements.py`:
```python
# Note: Case-specific agreement endpoints (create, get by case_id) are in cases.py router
```

**Resolution:**
- âœ… Updated `agreementsAPI.create()` to use correct endpoint
- âœ… Changed from `POST /agreements/` to `POST /cases/{case_id}/agreement`
- âœ… Extract `case_id` from request data and use in URL path
- âœ… Send remaining agreement data (title, agreement_type) in body

**Code Changes:**
```typescript
// Before (incorrect)
async create(data: CreateAgreementRequest): Promise<Agreement> {
  return fetchAPI<Agreement>('/agreements/', {
    method: 'POST',
    body: JSON.stringify(data),
  });
}

// After (correct)
async create(data: CreateAgreementRequest): Promise<Agreement> {
  const { case_id, ...agreementData } = data;
  return fetchAPI<Agreement>(`/cases/${case_id}/agreement`, {
    method: 'POST',
    body: JSON.stringify(agreementData),
  });
}
```

**Files Modified:**
- `frontend/lib/api.ts` (updated agreementsAPI.create() method)

---

### Bug #8: Case Association Verification Needed
**Severity:** HIGH  
**Status:** ğŸ”´ Open  
**Component:** Data Integrity / All Modules

**Description:**
Need to verify that all data entities (messages, agreements, schedules) are correctly associated with their parent case. Risk of data leakage between cases.

**Security/Privacy Concern:** ğŸ”’ HIGH PRIORITY

**Expected Behavior:**
- Messages belong only to their case
- Agreements belong only to their case
- Schedules belong only to their case
- No cross-case data leakage

**Actual Behavior:**
- Not verified/tested
- Potential for data appearing in wrong case

**Action Items:**
- [ ] Add case_id validation to all database queries
- [ ] Verify foreign key constraints in database
- [ ] Add integration tests for case isolation
- [ ] Audit all API endpoints for case_id filtering
- [ ] Test cross-case data access attempts
- [ ] Add logging for case_id mismatches

**Files to Check:**
- All API endpoints
- Database models (foreign keys)
- Query filters in services
- Frontend case context provider

**Database Tables to Verify:**
- `messages` â†’ `case_id` foreign key
- `agreements` â†’ `case_id` foreign key
- `schedule_events` â†’ `case_id` foreign key
- `payments` â†’ `case_id` foreign key

**Test Cases Needed:**
1. User A creates message in Case 1
2. User B (in Case 2) should NOT see User A's message
3. Agreements should only show for correct case
4. Schedule events isolated by case
5. All queries must filter by case_id

**Security Check:**
```python
# Every query should look like:
messages = db.query(Message).filter(
    Message.case_id == case_id,
    # Other filters...
).all()

# NOT like this:
messages = db.query(Message).all()  # âŒ No case filter!
```

---

### Bug #9: Section 9 (Transportation) Next Button Not Activating
**Severity:** MEDIUM
**Status:** ğŸŸ¡ In Progress
**Component:** Agreement Builder / Form Validation
**Reported:** December 30, 2025

**Description:**
User reports that in the agreement builder, when completing Section 9 (Transportation), the "Save & Continue" button does not become active even after filling in all required fields.

**Expected Behavior:**
- User fills in the required "Transportation Cost Arrangement" select field
- "Save & Continue" button becomes enabled
- User can proceed to next section

**Actual Behavior:**
- User fills in the required field
- Button remains disabled
- Cannot proceed to Section 10

**Investigation:**
The section template uses this validation logic:
```typescript
const isValid = fields
  .filter((f) => f.required)
  .every((f) => formData[f.name]?.trim());
```

Section 9 has one required field:
- `cost_arrangement` (type: 'select')
- Options: 'Each Pays Own|Split 50/50|One Parent Pays All|Meet Halfway|Based on Income Percentages'

**Debugging Steps Taken:**
1. âœ… Reviewed validation logic - appears correct
2. âœ… Added console logging to show invalid fields
3. âœ… Added visual indicators (âœ“ for filled, "(required)" for unfilled)
4. âœ… Added debug panel showing which required fields are incomplete
5. â³ Awaiting user testing to see console output

**Enhanced Features Added:**
```typescript
// Explicit boolean conversion for validation
const isFieldValid = Boolean(trimmed);

// Console debugging
console.log(`Field "${f.name}" is invalid:`, {
  value,
  trimmed,
  hasValue: Boolean(value),
  afterTrim: Boolean(trimmed)
});

// Visual field indicators in UI
{field.required && isFieldFilled && (
  <span className="text-green-600 text-xs">âœ“</span>
)}

// Debug panel showing incomplete fields
{!isValid && (
  <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
    <p className="text-sm font-medium text-yellow-900">Required fields not completed:</p>
    <ul>
      {fields.filter(f => f.required && !formData[f.name]?.trim()).map(f => (
        <li>{f.label}</li>
      ))}
    </ul>
  </div>
)}
```

**Potential Root Causes:**
1. **State Update Timing:** React state updates are async - formData might not be updating
2. **Select Field Value:** Default `value=""` might not be clearing properly when option selected
3. **Initial Data Loading:** If section has saved data, might not be loading correctly
4. **Validation Race Condition:** `isValid` might be computed before state updates

**Files Modified:**
- `frontend/components/agreements/sections/_section-template.tsx` (added debugging and visual feedback)

**Next Steps:**
1. User tests with debug features enabled
2. Check browser console for debug output
3. Verify which field(s) showing as incomplete
4. If issue persists, add `useEffect` to log state changes
5. May need to add React DevTools inspection

**Workaround (Temporary):**
None yet - investigating.

---

## ğŸ“Š Bug Summary

| Priority | Status | Count |
|----------|--------|-------|
| ğŸš¨ CRITICAL | ğŸŸ¢ Resolved | 2/3 |
| ğŸš¨ CRITICAL | ğŸ”´ Open | 1/3 |
| HIGH | ğŸ”´ Open | 1/1 |
| MEDIUM | ğŸŸ¢ Resolved | 3/5 |
| MEDIUM | ğŸ”´ Open | 1/5 |
| MEDIUM | ğŸŸ¡ In Progress | 1/5 |

**Resolved (5/9):**
1. âœ… Bug #1 - Navigation elements added
2. âœ… Bug #2 - CTA buttons added
3. âœ… Bug #3 - Schedule in navigation
4. âœ… Bug #5 - Message send format fixed
5. âœ… Bug #7 - Agreement creation endpoint fixed

**In Progress (1/9):**
1. ğŸŸ¡ Bug #9 - Section 9 validation issue (debugging features added, awaiting testing)

**Still Open (3/9):**
1. ğŸ”´ Bug #4 - Agreement builder fails to load case (CRITICAL)
2. ğŸ”´ Bug #6 - ARIA prompting improvement (MEDIUM)
3. ğŸ”´ Bug #8 - Case association verification (HIGH)

**Next Steps:**
1. Test Bug #9 - User needs to test with new debug features and report console output
2. Test Bug #4 - May be resolved by endpoint fixes
3. Address Bug #8 - Data integrity/security testing
4. Improve Bug #6 - ARIA prompt refinement

---

## ğŸ”§ Development Notes

### Testing Checklist (After Fixes)
- [ ] Can create new case
- [ ] Can navigate to agreement builder from case
- [ ] Can create new agreement (all types)
- [ ] Can send messages
- [ ] ARIA analyzes messages correctly
- [ ] Navigation shows all features
- [ ] All buttons functional
- [ ] Data isolated by case (security test)

### Files Most Likely Affected
- `lib/api.ts` - Error handling (Bugs #4, #5, #7)
- Navigation component - Missing features (Bugs #1, #2, #3)
- `app/api/v1/endpoints/agreements.py` - Backend (Bugs #4, #7)
- `app/api/v1/endpoints/messages.py` - Backend (Bug #5)
- All service files - Case isolation (Bug #8)

---

## ğŸ“ Notes for Claude

When fixing these bugs:

1. **Check `IMPLEMENTATION_PROGRESS.md`** - See what's actually implemented
2. **Review `lib/api.ts`** - Multiple bugs trace to error handling here
3. **Test backend endpoints** - Use FastAPI docs at `/docs`
4. **Verify case_id flow** - Critical for data integrity
5. **Add logging** - Help debug future issues
6. **Update tests** - Prevent regression

---

## ğŸ‰ Resolution Summary

**Session Date:** December 30, 2025
**Bugs Fixed:** 5/9 (55.6%)
**In Progress:** 1/9 (11.1%)
**Critical Bugs Resolved:** 2/3

### What Was Fixed

1. **Navigation System** - Created comprehensive navigation component with all pages
2. **Dashboard UX** - Added missing CTA buttons for agreement building and messaging
3. **API Integration** - Fixed message send and agreement creation endpoint mismatches
4. **Request Formats** - Aligned frontend request schemas with backend expectations

### Changes Made

**New Files:**
- `frontend/components/navigation.tsx` - Complete navigation system

**Modified Files:**
- `frontend/app/dashboard/page.tsx` - Integrated navigation, added CTA buttons
- `frontend/lib/api.ts` - Fixed message and agreement API calls

### Testing Recommendations

Before deploying:
1. Test message sending with real case data
2. Verify agreement creation flow works end-to-end
3. Confirm navigation works on all pages
4. Test responsive design on mobile devices

---

*Last Updated: December 30, 2025*
*Status: 5/9 bugs resolved, 1 in progress (validation debugging), 3 open (1 critical, 1 high, 1 medium)*